#!/usr/bin/env bash

VERBOSE=false
DRYRUN=false
case $1 in
  -v|--verbose) VERBOSE=true ; shift ;;
  -d|--dry-run) DRYRUN=true ; VERBOSE=true ; shift ;;
esac

set -- $(find .* -maxdepth 0 -not -name '.git' | tail +3)

function _backup() {
  local dotfile=$1
  $VERBOSE && echo "mv --force $HOME/$dotfile $HOME/.config/backup/"
  $DRYRUN && return
  [ ! -d $HOME/.config/backup ] && mkdir $HOME/.config/backup
  mv -f $HOME/$dotfile $HOME/.config/backup/ >/dev/null
}

function _remove() {
  local dotfile=$1
  $VERBOSE && echo "rm --force $HOME/$dotfile"
  $DRYRUN && return
  rm -f $HOME/$dotfile >/dev/null
}

function _link() {
  local dotfile=$1
  if [ $dotfile == ".nanorc" ] ; then
    $VERBOSE && echo "bash $dotfile > $HOME/$dotfile"
    $DRYRUN && return
    cat $dotfile | cut -c3- | bash > "$HOME/$dotfile"
  else
    $VERBOSE && echo "ln --symbolic $PWD/$dotfile $HOME/$dotfile"
    $DRYRUN && return
    ln -s $PWD/$dotfile $HOME/$dotfile >/dev/null
  fi
}

function _dotdir() {
  for dotfile in $(find $1/* -maxdepth 0 -not -name '.git' -not -name '*.md') ; do
    _dotfile $dotfile
  done
}

function _dotfile() {
  local dotfile=$1
  $VERBOSE || echo $dotfile
  if [ -e $HOME/$dotfile ] ; then
    if [ -L $HOME/$dotfile ] ; then
      _remove $dotfile
      _link $dotfile
    elif [ -d $HOME/$dotfile ] ; then
      _dotdir $dotfile
    else
      _backup $dotfile
      _link $dotfile
    fi
  else
    _link $dotfile
  fi
}

git submodule update --init >/dev/null || exit 1

for dotfile in "$@" ; do
  _dotfile $dotfile
done

$DRYRUN && {
  echo "DRY-RUN: nothing was changed on your system" >&2
} || {
  $VERBOSE || echo $HOME/.config/backup
  $VERBOSE && find $HOME/.config/backup 2>/dev/null
}

# EOF
